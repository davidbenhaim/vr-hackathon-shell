<html>

<head>
  <title>Augmented Reality Marker Detector</title>
  <script type="text/javascript" src="lib/cv.js"></script>
  <script type="text/javascript" src="lib/aruco.js"></script>

  <script>
    var video, canvas, context, imageData, detector;
    aruco = require('node-aruco');
    nativeImage = require('electron').nativeImage;

    function getDimensions(){
    	canvas = document.getElementById('canvas');
    	width = canvas.style.width;
    	height = canvas.style.height;
    	return {width: width, height: height}
    }

    function onLoad(){
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      context = canvas.getContext("2d");
      dims = getDimensions()
      canvas.width = 640;
      canvas.height = 480;

      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (navigator.getUserMedia){

        function successCallback(stream){
          if (window.webkitURL) {
            video.src = window.webkitURL.createObjectURL(stream);
          } else if (video.mozSrcObject !== undefined) {
            video.mozSrcObject = stream;
          } else {
            video.src = stream;
          }
        }

        function errorCallback(error){
        }

        navigator.getUserMedia({video: true}, successCallback, errorCallback);

        detector = new AR.Detector();
        requestAnimationFrame(tick);
      }
    }

    function tick(){
      var start = new Date();
      // dims = getDimensions()
      // canvas.width = dims.width;
      // canvas.height = dims.height;
      requestAnimationFrame(tick);

      if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();
        var markers = aruco.detect(imageData); //detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
      }
      // var end = new Date();
      // console.log(end - start);
    }

    function snapshot(){
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
	  // imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      imageData = nativeImage.createFromDataURL(canvas.toDataURL()).toJPEG(100);
    }

    function drawCorners(markers){
      var corners, corner, i, j;

      context.lineWidth = 3;
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].points;

        context.strokeStyle = "red";
        context.beginPath();

        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
        }
        context.stroke();
        context.closePath();

        context.strokeStyle = "green";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
      }
    }
    function drawId(markers){
      var corners, corner, x, y, i, j;

      context.strokeStyle = "blue";
      context.lineWidth = 1;

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].points;

        x = Infinity;
        y = Infinity;

        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];

          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
        }
        context.strokeText(markers[i].id, x, y)
      }
    }
    window.onload = onLoad;
  </script>

</head>

<body style="font-family: monospace;">

  <center>
    <video id="video" autoplay="true" style="display: none;"></video>
    <canvas id="canvas" style="width: 100%; margin: 50px;"></canvas>
  </center>

</body>

</html>
